## Usages

### Usage Records

`Usage records` represent the most atomic piece of information regarding usages.
It is a REST resource managed by the API server. As it is a technical resource (used only internally by Web Server and 
not exposed to SlipStream users, only POST operation is currently supported). 

A usage record is typically created by Web server during the lifecycle of a VM.
A POST is made with a new usage record (that does not contain an end_timestamp) when a VM is started.
When it is stopped, another POST is made with the same information but including the `end_timestamp`.
See UsageRecorder class for more details.

_Note that a single usage record is stored in database on multiple rows (one for each metric)._

#### Some useful SQL commands

To count the number of usage records:

```
java -jar /opt/hsqldb/lib/sqltool.jar --inlineRc=url=jdbc:hsqldb:hsql://localhost:9001/ssclj,user=sa,password= --sql 'select count(*) from "usage_records";'
```

To list the 3 first usage recrds of `sixsq_dev` on `ec-eu-west`

```
java -jar /opt/hsqldb/lib/sqltool.jar --inlineRc=url=jdbc:hsqldb:hsql://localhost:9001/ssclj,user=sa,password= --sql "select * from \"usage_records\" where \"cloud\"='ec2-eu-west' and \"user\"='sixsq_dev' limit 3;"
```

cloud_vm_instanceid    | user      | cloud       | start_timestamp          | end_timestamp            | metric_name | metric_value
---------------------- | --------- | ----------- | ------------------------ | ------------------------ | ----------- | ------------
ec2-eu-west:i-8034d12a | sixsq_dev | ec2-eu-west | 2015-05-08T02:18:17.816Z | 2015-05-08T02:23:29.097Z | vm          |        1.0E0
ec2-eu-west:i-a5e7080f | sixsq_dev | ec2-eu-west | 2015-05-13T10:24:59.443Z | 2015-05-13T10:32:59.859Z | vm          |        1.0E0
ec2-eu-west:i-f56a9a5f | sixsq_dev | ec2-eu-west | 2015-05-19T11:25:52.620Z | 2015-05-19T11:29:01.093Z | vm          |        1.0E0

### Usage summaries

This is also a REST resource.

A Usage Summary is the aggregation of all metrics for a given time interval, user and cloud.
e.g:

```

{"vm":{"unit_minutes":1440.0},
 "ram":{"unit_minutes":4.718592E7},
 "disk":{"unit_minutes":0.0},
 "instance-type.Huge":{"unit_minutes":1440.0}}
```

### Process

#### Usage records

Start a usage record

******************************
*    ----                    *
*    ^                       *
*    |                       *
*    |                       *
*   -o--------------------   *
*    t0                      *
******************************

Close a usage record

******************************
*    --------                *
*    ^      |                *
*    |      |                *
*    |      |                *
*   -o------v------------    *
*    t0                      *
******************************



*****************************************
*                                       *
* .--------------.   .-------------.    *
* | VM lifecycle +->| Usage records |   *
* '--------------'   '-------------'    *
*                                       *
*                                       *
*****************************************

#### Computation of Usage Summaries

Each day at 2 AM (UTC), a cron job computes and stores the summaries for all users on each cloud.
Here are the details of the execution on nuv.la:

```
cron job: 
/etc/cron.d/create-daily-usage 

--> triggers at 2 AM

/usr/sbin/create-daily-usage.sh (simple wrapper around clojure launcher without arguments)

--> that calls  

com.sixsq.slipstream.ssclj.usage.daily_summary_launcher
```

`daily_summary_launcher` by default (no arguments) computes the summaries for yesterday.
It can also be called with optional arguments `-d date`
e.g: 

```
daily_summary_launcher -d 20150921
```

#### Manual checks

To summarize manually one given month from the command line:

```
java -Ddb.config.path=src/main/resources/config-hsqldb.edn \
   -cp ".:target/SlipStreamCljResources-jar-2.18-SNAPSHOT-jar-with-dependencies.jar" \
    com.sixsq.slipstream.ssclj.usage.monthly_summary_launcher \
    -m 2016-03     
```

To get one monthly usage for a given cloud:

```
curl -H "slipstream-authn-info: azure azure" "http://localhost:8201/api/usage?%24filter=start_timestamp%3D2016-03-01%20and%20end_timestamp%3D2016-04-01"
```

####Â Send Usage emails

Each day at 3 AM UTC, a cron job sends via email (to users having set the preference) these usage summaries.
Here are the details of the execution on nuv.la:

cron job:
/etc/cron.d/daily-usage-emails

--> triggers at 3 AM

/usr/sbin/send-daily-usage-emails.sh

--> that calls

com.sixsq.slipstream.action.DailyUsageSender (Java class actually doing the job)

The DailyUsageSender queries the Usage Summary resource with the help of the CIMI filter.

<style class="fallback">body{white-space:pre;font-family:monospace}</style><script src="markdeep.min.js"></script><script src="http://casual-effects.com/markdeep/latest/markdeep.min.js"></script>






